apiVersion: batch/v1
kind: Job
metadata:
  name: glass-avhrr-preprocessor
  labels:
    app: data-preprocess
    dataset: glass-avhrr
spec:
  ttlSecondsAfterFinished: 86400  # Auto-delete 24 hours after completion
  backoffLimit: 3  # Number of retries
  template:
    spec:
      # Use a dedicated service account with GCS access
      serviceAccountName: k8s-preprocessor
      restartPolicy: Never
      containers:
      - name: preprocess
        image: gcr.io/ee-growthandheat/preprocessor:latest
        args: ["/config/avhrr-preprocess-config.json"]
        resources:
          requests:
            cpu: "8"
            memory: "16Gi"
            ephemeral-storage: "5Gi"  # Request reasonable ephemeral storage
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        volumeMounts:
        - name: config-volume
          mountPath: /config
          readOnly: true
        - name: temp-storage
          mountPath: /tmp
      volumes:
      - name: config-volume
        configMap:
          name: avhrr-preprocess-config
      - name: temp-storage
        emptyDir:
          sizeLimit: "20Gi"  # Temporary storage for large files